<!DOCTYPE html>
<html>
<head>
  <title>DropVault - Dashboard</title>
  <meta name="csrf-token" content="{{ csrf_token }}">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      padding: 20px; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container { 
      max-width: 1000px; 
      margin: 0 auto; 
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      padding: 30px;
    }
    h1 { color: #333; margin-bottom: 5px; }
    h2 { color: #555; margin: 20px 0 15px; font-size: 1.3em; }
    .user-email { color: #666; margin-bottom: 20px; }
    
    /* Upload Form */
    .upload-section { 
      background: #f8f9fa; 
      padding: 20px; 
      border-radius: 8px; 
      margin-bottom: 20px;
      border: 2px dashed #dee2e6;
    }
    .upload-section:hover { border-color: #667eea; }
    #uploadForm { 
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    #uploadForm input[type="file"] {
      flex: 1;
      min-width: 200px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: #fff;
    }
    
    /* Buttons */
    button, .btn { 
      padding: 10px 18px; 
      font-size: 14px; 
      cursor: pointer; 
      border: none;
      border-radius: 6px;
      transition: all 0.2s;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    button:hover { transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
    button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    
    .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
    .btn-danger { background: #dc3545; color: white; }
    .btn-success { background: #28a745; color: white; }
    .btn-secondary { background: #6c757d; color: white; }
    .btn-warning { background: #ffc107; color: #333; }
    .btn-sm { padding: 6px 12px; font-size: 12px; }
    
    /* Tabs */
    .tabs { 
      display: flex; 
      gap: 0; 
      margin: 25px 0 20px;
      border-bottom: 2px solid #eee;
    }
    .tab { 
      padding: 12px 24px; 
      background: transparent; 
      border: none; 
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-weight: 600;
      color: #666;
      margin-bottom: -2px;
      transition: all 0.2s;
    }
    .tab:hover { color: #667eea; }
    .tab.active { 
      color: #667eea; 
      border-bottom-color: #667eea;
    }
    
    /* Content Sections */
    .content-section {
      background: #fff;
      border-radius: 8px;
      min-height: 200px;
    }
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    
    /* File List */
    .file-list { list-style: none; }
    .file-item { 
      padding: 15px; 
      border: 1px solid #eee;
      border-radius: 8px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
      transition: all 0.2s;
    }
    .file-item:hover { 
      border-color: #667eea; 
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
    }
    
    .file-info { flex: 1; min-width: 200px; }
    .file-name { 
      font-weight: 600; 
      color: #333; 
      word-break: break-all;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .file-icon { font-size: 1.5em; }
    .file-meta { color: #888; font-size: 0.85em; margin-top: 5px; }
    
    .file-actions { 
      display: flex; 
      gap: 8px; 
      flex-wrap: wrap;
      align-items: center;
    }
    
    /* Share Dropdown */
    .share-dropdown { position: relative; display: inline-block; }
    .share-menu {
      display: none;
      position: absolute;
      right: 0;
      top: calc(100% + 5px);
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 10px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      padding: 20px;
      z-index: 1000;
      min-width: 300px;
    }
    .share-menu.show { display: block; }
    .share-menu::before {
      content: '';
      position: absolute;
      top: -8px;
      right: 20px;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-bottom: 8px solid #fff;
    }
    .share-menu h4 { margin: 0 0 15px; color: #333; font-size: 1em; }
    .share-menu input, .share-menu textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      margin-bottom: 10px;
      font-family: inherit;
    }
    .share-menu input:focus, .share-menu textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    .share-menu textarea { height: 70px; resize: vertical; }
    .share-menu label { 
      display: block; 
      margin-bottom: 5px; 
      font-weight: 500; 
      color: #555;
      font-size: 0.9em;
    }
    .share-divider {
      border: none;
      border-top: 1px solid #eee;
      margin: 15px 0;
    }
    .share-menu .btn { width: 100%; justify-content: center; }
    
    /* Status Messages */
    .status { 
      padding: 10px 15px; 
      border-radius: 6px; 
      margin-top: 10px; 
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .status.loading { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
    .status.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    
    /* Copy Link Input */
    .copy-link-container {
      display: none;
      margin-top: 10px;
      padding: 10px;
      background: #e8f5e9;
      border-radius: 6px;
      border: 1px solid #c8e6c9;
    }
    .copy-link-container input {
      width: 100%;
      padding: 8px;
      border: 1px solid #a5d6a7;
      border-radius: 4px;
      font-size: 12px;
      background: #fff;
      margin: 0;
    }
    .copy-link-container small {
      display: block;
      margin-top: 5px;
      color: #2e7d32;
      font-size: 11px;
    }
    
    /* Trash Specific */
    .trash-info {
      background: #fff3cd;
      border: 1px solid #ffeeba;
      padding: 12px 15px;
      border-radius: 6px;
      margin-bottom: 15px;
      color: #856404;
      font-size: 0.9em;
    }
    .days-badge { 
      display: inline-block; 
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.8em;
      font-weight: 600;
      margin-top: 5px;
    }
    .days-badge.safe { background: #d4edda; color: #155724; }
    .days-badge.warning { background: #fff3cd; color: #856404; }
    .days-badge.danger { background: #f8d7da; color: #721c24; }
    
    .empty-state { 
      text-align: center; 
      padding: 60px 20px; 
      color: #888;
    }
    .empty-state .icon { font-size: 4em; margin-bottom: 15px; opacity: 0.5; }
    .empty-state h3 { color: #666; margin-bottom: 10px; }
    .empty-state p { font-size: 0.95em; }
    
    /* Shared Links Section */
    .shared-section {
      margin-top: 30px;
      padding-top: 20px;
      border-top: 2px solid #eee;
    }
    .shared-link-item {
      padding: 15px;
      border: 1px solid #eee;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    .shared-link-item:hover { border-color: #667eea; }
    .link-url { 
      font-family: monospace; 
      background: #f8f9fa; 
      padding: 5px 10px; 
      border-radius: 4px;
      font-size: 0.85em;
      word-break: break-all;
    }
    .link-stats { 
      display: flex; 
      gap: 15px; 
      margin-top: 8px; 
      font-size: 0.85em; 
      color: #666; 
    }
    .link-status { font-weight: 600; }
    .link-status.active { color: #28a745; }
    .link-status.expired { color: #dc3545; }
    
    /* Loading Spinner */
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #ddd;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Responsive */
    @media (max-width: 600px) {
      body { padding: 10px; }
      .container { padding: 15px; }
      .file-item { flex-direction: column; align-items: flex-start; }
      .file-actions { width: 100%; justify-content: flex-start; margin-top: 10px; }
      .share-menu { left: 0; right: auto; min-width: 260px; }
    }
  </style>
</head>
<body>
<div class="container">
  <h1>ğŸ“ DropVault</h1>
  <p class="user-email">Welcome, <strong>{{ user.email }}</strong></p>

  <!-- Upload Section -->
  <div class="upload-section">
    <form id="uploadForm" enctype="multipart/form-data">
      {% csrf_token %}
      <input type="file" name="file" id="fileInput" required>
      <button type="submit" class="btn btn-primary" id="uploadBtn">
        ğŸ“¤ Upload File
      </button>
    </form>
    <div id="uploadStatus"></div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button id="files-tab" class="tab active" onclick="showTab('files')">
      ğŸ“ My Files
    </button>
    <button id="trash-tab" class="tab" onclick="showTab('trash')">
      ğŸ—‘ï¸ Trash (<span id="trash-count">0</span>)
    </button>
  </div>

  <!-- Files Section -->
  <div id="files-section" class="content-section">
    <div class="section-header">
      <h2>Your Files</h2>
      <button onclick="loadFiles()" class="btn btn-secondary btn-sm">ğŸ”„ Refresh</button>
    </div>
    <ul id="fileList" class="file-list">
      <li class="empty-state">
        <div class="icon">ğŸ“‚</div>
        <h3>Loading...</h3>
      </li>
    </ul>
  </div>

  <!-- Trash Section -->
  <div id="trash-section" class="content-section" style="display: none;">
    <div class="section-header">
      <h2>ğŸ—‘ï¸ Trash</h2>
      <button onclick="loadTrashFiles()" class="btn btn-secondary btn-sm">ğŸ”„ Refresh</button>
    </div>
    <div class="trash-info">
      âš ï¸ Files in trash will be <strong>permanently deleted after 30 days</strong>. 
      Restore them before it's too late!
    </div>
    <div id="trashList">
      <div class="empty-state">
        <div class="icon">ğŸ—‘ï¸</div>
        <h3>Loading...</h3>
      </div>
    </div>
  </div>

  <!-- Shared Links Section -->
  <div class="shared-section">
    <h2>ğŸ”— Shared Links</h2>
    {% if shared_links %}
      {% for link in shared_links %}
        <div class="shared-link-item">
          <strong>ğŸ“„ {{ link.file.original_name }}</strong>
          {% if link.slug %}
            <div class="link-url">/s/{{ link.slug }}/</div>
          {% endif %}
          <div class="link-stats">
            <span>ğŸ‘ï¸ Views: {{ link.view_count }}</span>
            <span>â¬‡ï¸ Downloads: {{ link.download_count }}/{{ link.max_downloads }}</span>
            <span class="link-status {% if link.is_expired %}expired{% else %}active{% endif %}">
              {% if link.is_expired %}âŒ Expired{% else %}âœ… Active{% endif %}
            </span>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="empty-state" style="padding: 30px;">
        <p>No shared links yet. Share a file to see it here!</p>
      </div>
    {% endif %}
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”§ CONFIGURATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '{{ csrf_token }}';
let currentTab = 'files';

console.log('ğŸš€ Dashboard loaded');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“‘ TAB SWITCHING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showTab(tab) {
  currentTab = tab;
  
  // Update tab buttons
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById(tab + '-tab').classList.add('active');
  
  // Show/hide sections
  document.getElementById('files-section').style.display = tab === 'files' ? 'block' : 'none';
  document.getElementById('trash-section').style.display = tab === 'trash' ? 'block' : 'none';
  
  // Load data
  if (tab === 'files') {
    loadFiles();
  } else {
    loadTrashFiles();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“¤ UPLOAD FILE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('uploadForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const fileInput = document.getElementById('fileInput');
  const uploadBtn = document.getElementById('uploadBtn');
  const statusDiv = document.getElementById('uploadStatus');
  
  if (!fileInput.files || fileInput.files.length === 0) {
    statusDiv.innerHTML = '<div class="status error">âŒ Please select a file</div>';
    return;
  }
  
  const file = fileInput.files[0];
  console.log('ğŸ“¤ Uploading:', file.name, formatFileSize(file.size));
  
  // Show loading
  uploadBtn.disabled = true;
  uploadBtn.innerHTML = '<span class="spinner"></span> Uploading...';
  statusDiv.innerHTML = `<div class="status loading"><span class="spinner"></span> Uploading ${escapeHtml(file.name)}...</div>`;
  
  const formData = new FormData();
  formData.append('file', file);
  
  try {
    const response = await fetch('/files/upload/', {
      method: 'POST',
      body: formData,
      headers: { 'X-CSRFToken': csrfToken },
      credentials: 'same-origin'
    });
    
    const data = await response.json();
    console.log('ğŸ“¤ Response:', response.status, data);
    
    if (response.ok) {
      statusDiv.innerHTML = `<div class="status success">âœ… "${escapeHtml(file.name)}" uploaded successfully!</div>`;
      fileInput.value = '';
      loadFiles();
      
      setTimeout(() => { statusDiv.innerHTML = ''; }, 4000);
    } else {
      throw new Error(data.error || data.message || 'Upload failed');
    }
  } catch (error) {
    console.error('âŒ Upload error:', error);
    statusDiv.innerHTML = `<div class="status error">âŒ ${escapeHtml(error.message)}</div>`;
  } finally {
    uploadBtn.disabled = false;
    uploadBtn.innerHTML = 'ğŸ“¤ Upload File';
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“‚ LOAD FILES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadFiles() {
  console.log('ğŸ“‚ Loading files...');
  const fileList = document.getElementById('fileList');
  
  fileList.innerHTML = `
    <li class="empty-state">
      <div class="spinner" style="width: 40px; height: 40px; border-width: 3px;"></div>
      <h3 style="margin-top: 15px;">Loading files...</h3>
    </li>
  `;
  
  try {
    const response = await fetch('/api/list/', {
      headers: { 'X-CSRFToken': csrfToken },
      credentials: 'same-origin'
    });
    
    if (!response.ok) throw new Error('Failed to fetch files');
    
    const files = await response.json();
    console.log('ğŸ“‚ Loaded:', files.length, 'files');
    
    if (!Array.isArray(files) || files.length === 0) {
      fileList.innerHTML = `
        <li class="empty-state">
          <div class="icon">ğŸ“</div>
          <h3>No files yet</h3>
          <p>Upload your first file using the form above!</p>
        </li>
      `;
      return;
    }
    
    fileList.innerHTML = files.map(f => createFileItem(f)).join('');
    
  } catch (error) {
    console.error('âŒ Load error:', error);
    fileList.innerHTML = `
      <li class="empty-state">
        <div class="icon">âŒ</div>
        <h3>Error loading files</h3>
        <p>${escapeHtml(error.message)}</p>
        <button onclick="loadFiles()" class="btn btn-primary" style="margin-top: 15px;">Try Again</button>
      </li>
    `;
  }
}

function createFileItem(f) {
  const fileName = f.original_name || f.filename;
  const fileId = f.id;
  const ext = fileName.split('.').pop().toLowerCase();
  const icon = getFileIcon(ext);
  
  return `
    <li class="file-item" data-file-id="${fileId}">
      <div class="file-info">
        <div class="file-name">
          <span class="file-icon">${icon}</span>
          ${escapeHtml(fileName)}
        </div>
        <div class="file-meta">
          ${formatFileSize(f.size)} â€¢ ${formatDate(f.uploaded_at)}
        </div>
      </div>
      <div class="file-actions">
        <button onclick="deleteFile(${fileId}, '${escapeJs(fileName)}')" class="btn btn-danger btn-sm">
          ğŸ—‘ï¸ Delete
        </button>
        <div class="share-dropdown">
          <button onclick="toggleShare(event, ${fileId})" class="btn btn-primary btn-sm">
            ğŸ“¤ Share
          </button>
          <div id="share-menu-${fileId}" class="share-menu">
            <h4>ğŸ“¤ Share File</h4>
            
            <button onclick="copyLink(${fileId})" class="btn btn-secondary">
              ğŸ”— Copy Share Link
            </button>
            
            <div id="link-container-${fileId}" class="copy-link-container">
              <input type="text" id="link-input-${fileId}" readonly onclick="this.select()">
              <small>âœ… Link copied! Anyone with this link can download.</small>
            </div>
            
            <hr class="share-divider">
            
            <label>ğŸ“§ Email to:</label>
            <input type="email" id="email-${fileId}" placeholder="recipient@example.com">
            
            <label>Message (optional):</label>
            <textarea id="message-${fileId}" placeholder="Hey, check out this file!"></textarea>
            
            <button onclick="sendEmail(${fileId})" class="btn btn-success">
              ğŸ“§ Send Email
            </button>
            
            <div id="share-status-${fileId}"></div>
          </div>
        </div>
      </div>
    </li>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ—‘ï¸ DELETE FILE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function deleteFile(fileId, fileName) {
  if (!confirm(`Move "${fileName}" to trash?`)) return;
  
  console.log('ğŸ—‘ï¸ Deleting:', fileId);
  
  try {
    const response = await fetch(`/files/delete/${fileId}/`, {
      method: 'POST',
      headers: { 
        'X-CSRFToken': csrfToken,
        'Content-Type': 'application/json'
      },
      credentials: 'same-origin'
    });
    
    const data = await response.json();
    console.log('ğŸ—‘ï¸ Response:', data);
    
    if (response.ok) {
      // Animate removal
      const item = document.querySelector(`[data-file-id="${fileId}"]`);
      if (item) {
        item.style.transition = 'all 0.3s';
        item.style.opacity = '0';
        item.style.transform = 'translateX(20px)';
        setTimeout(() => {
          item.remove();
          // Check if list is empty
          const fileList = document.getElementById('fileList');
          if (!fileList.querySelector('.file-item')) {
            fileList.innerHTML = `
              <li class="empty-state">
                <div class="icon">ğŸ“</div>
                <h3>No files</h3>
                <p>All files have been moved to trash</p>
              </li>
            `;
          }
        }, 300);
      }
      updateTrashCount();
    } else {
      throw new Error(data.error || 'Delete failed');
    }
  } catch (error) {
    console.error('âŒ Delete error:', error);
    alert('âŒ ' + error.message);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ—‘ï¸ LOAD TRASH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadTrashFiles() {
  console.log('ğŸ—‘ï¸ Loading trash...');
  const trashList = document.getElementById('trashList');
  
  trashList.innerHTML = `
    <div class="empty-state">
      <div class="spinner" style="width: 40px; height: 40px; border-width: 3px;"></div>
      <h3 style="margin-top: 15px;">Loading trash...</h3>
    </div>
  `;
  
  try {
    const response = await fetch('/api/trash/', {
      headers: { 'X-CSRFToken': csrfToken },
      credentials: 'same-origin'
    });
    
    console.log('ğŸ—‘ï¸ Response status:', response.status);
    
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    
    const data = await response.json();
    console.log('ğŸ—‘ï¸ Trash data:', data);
    
    const files = Array.isArray(data) ? data : [];
    document.getElementById('trash-count').textContent = files.length;
    
    if (files.length === 0) {
      trashList.innerHTML = `
        <div class="empty-state">
          <div class="icon">ğŸ—‘ï¸</div>
          <h3>Trash is empty</h3>
          <p>Deleted files will appear here</p>
        </div>
      `;
      return;
    }
    
    trashList.innerHTML = files.map(f => createTrashItem(f)).join('');
    
  } catch (error) {
    console.error('âŒ Trash error:', error);
    trashList.innerHTML = `
      <div class="empty-state">
        <div class="icon">âŒ</div>
        <h3>Error loading trash</h3>
        <p>${escapeHtml(error.message)}</p>
        <button onclick="loadTrashFiles()" class="btn btn-primary" style="margin-top: 15px;">Try Again</button>
      </div>
    `;
  }
}

function createTrashItem(f) {
  const fileName = f.filename || f.original_name;
  const days = f.days_remaining ?? 30;
  let daysClass = 'safe';
  if (days <= 7) daysClass = 'danger';
  else if (days <= 14) daysClass = 'warning';
  
  const deletedDate = f.deleted_at 
    ? new Date(f.deleted_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
    : 'Unknown';
  
  return `
    <div class="file-item" data-trash-id="${f.id}">
      <div class="file-info">
        <div class="file-name">
          <span class="file-icon">ğŸ“„</span>
          ${escapeHtml(fileName)}
        </div>
        <div class="file-meta">
          ${formatFileSize(f.size)} â€¢ Deleted: ${deletedDate}
        </div>
        <span class="days-badge ${daysClass}">
          â° ${days} days left
        </span>
      </div>
      <div class="file-actions">
        <button onclick="restoreFile(${f.id}, '${escapeJs(fileName)}')" class="btn btn-success btn-sm">
          â™»ï¸ Restore
        </button>
      </div>
    </div>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â™»ï¸ RESTORE FILE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function restoreFile(fileId, fileName) {
  if (!confirm(`Restore "${fileName}"?`)) return;
  
  console.log('â™»ï¸ Restoring:', fileId);
  
  try {
    const response = await fetch(`/api/restore/${fileId}/`, {
      method: 'POST',
      headers: { 
        'X-CSRFToken': csrfToken,
        'Content-Type': 'application/json'
      },
      credentials: 'same-origin'
    });
    
    const data = await response.json();
    console.log('â™»ï¸ Response:', data);
    
    if (response.ok && (data.status === 'success' || data.success)) {
      // Animate removal from trash
      const item = document.querySelector(`[data-trash-id="${fileId}"]`);
      if (item) {
        item.style.transition = 'all 0.3s';
        item.style.opacity = '0';
        item.style.background = '#d4edda';
        setTimeout(() => {
          item.remove();
          updateTrashCount();
          // Check if trash is empty
          const trashList = document.getElementById('trashList');
          if (!trashList.querySelector('.file-item')) {
            trashList.innerHTML = `
              <div class="empty-state">
                <div class="icon">ğŸ—‘ï¸</div>
                <h3>Trash is empty</h3>
                <p>Deleted files will appear here</p>
              </div>
            `;
          }
        }, 300);
      }
      alert('âœ… File restored!');
    } else {
      throw new Error(data.error || data.message || 'Restore failed');
    }
  } catch (error) {
    console.error('âŒ Restore error:', error);
    alert('âŒ ' + error.message);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“¤ SHARING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleShare(event, fileId) {
  event.stopPropagation();
  
  // Close all other menus
  document.querySelectorAll('.share-menu').forEach(menu => {
    if (menu.id !== `share-menu-${fileId}`) {
      menu.classList.remove('show');
    }
  });
  
  const menu = document.getElementById(`share-menu-${fileId}`);
  menu.classList.toggle('show');
}

// Close menus on outside click
document.addEventListener('click', function(e) {
  if (!e.target.closest('.share-dropdown')) {
    document.querySelectorAll('.share-menu').forEach(m => m.classList.remove('show'));
  }
});

async function copyLink(fileId) {
  console.log('ğŸ”— Creating link for:', fileId);
  const statusDiv = document.getElementById(`share-status-${fileId}`);
  const linkContainer = document.getElementById(`link-container-${fileId}`);
  const linkInput = document.getElementById(`link-input-${fileId}`);
  
  statusDiv.innerHTML = '<div class="status loading"><span class="spinner"></span> Creating link...</div>';
  
  try {
    const response = await fetch(`/files/share/${fileId}/`, {
      method: 'POST',
      headers: { 
        'X-CSRFToken': csrfToken,
        'Content-Type': 'application/json'
      },
      credentials: 'same-origin',
      body: '{}'
    });
    
    const data = await response.json();
    console.log('ğŸ”— Response:', data);
    
    if (!response.ok) throw new Error(data.error || 'Failed');
    
    const url = data.share_url || data.link;
    if (!url) throw new Error('No URL returned');
    
    linkInput.value = url;
    linkContainer.style.display = 'block';
    linkInput.select();
    
    try {
      await navigator.clipboard.writeText(url);
      statusDiv.innerHTML = '<div class="status success">âœ… Link copied!</div>';
    } catch {
      statusDiv.innerHTML = '<div class="status info">ğŸ“‹ Select and copy the link above</div>';
    }
    
    setTimeout(() => { statusDiv.innerHTML = ''; }, 3000);
    
  } catch (error) {
    console.error('âŒ Link error:', error);
    statusDiv.innerHTML = `<div class="status error">âŒ ${escapeHtml(error.message)}</div>`;
  }
}

async function sendEmail(fileId) {
  const emailInput = document.getElementById(`email-${fileId}`);
  const messageInput = document.getElementById(`message-${fileId}`);
  const statusDiv = document.getElementById(`share-status-${fileId}`);
  
  const email = emailInput.value.trim();
  const message = messageInput.value.trim();
  
  if (!email) {
    statusDiv.innerHTML = '<div class="status error">âŒ Please enter an email address</div>';
    return;
  }
  
  if (!email.includes('@') || !email.includes('.')) {
    statusDiv.innerHTML = '<div class="status error">âŒ Please enter a valid email</div>';
    return;
  }
  
  console.log('ğŸ“§ Sending to:', email);
  statusDiv.innerHTML = '<div class="status loading"><span class="spinner"></span> Sending...</div>';
  
  try {
    const response = await fetch(`/files/share/${fileId}/email/`, {
      method: 'POST',
      headers: { 
        'X-CSRFToken': csrfToken,
        'Content-Type': 'application/json'
      },
      credentials: 'same-origin',
      body: JSON.stringify({ 
        recipient_email: email, 
        message: message 
      })
    });
    
    const data = await response.json();
    console.log('ğŸ“§ Response:', data);
    
    if (!response.ok) throw new Error(data.error || 'Failed to share');
    
    if (data.email_sent) {
      statusDiv.innerHTML = `<div class="status success">âœ… Email sent to ${escapeHtml(email)}!</div>`;
      emailInput.value = '';
      messageInput.value = '';
    } else {
      const url = data.share_url || '';
      statusDiv.innerHTML = `
        <div class="status info">
          âš ï¸ Email not sent. Share this link manually:<br>
          <input type="text" value="${escapeHtml(url)}" onclick="this.select()" readonly style="margin-top: 8px; font-size: 11px;">
        </div>
      `;
    }
    
  } catch (error) {
    console.error('âŒ Email error:', error);
    statusDiv.innerHTML = `<div class="status error">âŒ ${escapeHtml(error.message)}</div>`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”§ HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function updateTrashCount() {
  try {
    const response = await fetch('/api/trash/', {
      headers: { 'X-CSRFToken': csrfToken },
      credentials: 'same-origin'
    });
    const data = await response.json();
    const count = Array.isArray(data) ? data.length : 0;
    document.getElementById('trash-count').textContent = count;
  } catch (e) {
    console.error('Count error:', e);
  }
}

function formatFileSize(bytes) {
  if (!bytes) return '0 B';
  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

function formatDate(dateStr) {
  if (!dateStr) return '';
  const date = new Date(dateStr);
  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function escapeJs(text) {
  if (!text) return '';
  return text.replace(/'/g, "\\'").replace(/"/g, '\\"');
}

function getFileIcon(ext) {
  const icons = {
    'pdf': 'ğŸ“•', 'doc': 'ğŸ“˜', 'docx': 'ğŸ“˜', 'txt': 'ğŸ“„',
    'jpg': 'ğŸ–¼ï¸', 'jpeg': 'ğŸ–¼ï¸', 'png': 'ğŸ–¼ï¸', 'gif': 'ğŸ–¼ï¸',
    'mp4': 'ğŸ¬', 'mp3': 'ğŸµ', 'zip': 'ğŸ“¦', 'rar': 'ğŸ“¦',
    'xlsx': 'ğŸ“Š', 'csv': 'ğŸ“Š', 'ppt': 'ğŸ“™', 'pptx': 'ğŸ“™'
  };
  return icons[ext] || 'ğŸ“„';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸš€ INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded', function() {
  console.log('ğŸš€ Initializing dashboard...');
  loadFiles();
  updateTrashCount();
});
</script>
</body>
</html>