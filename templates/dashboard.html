<!DOCTYPE html>
<html>
<head>
  <title>DropVault - Dashboard</title>
  <meta name="csrf-token" content="{{ csrf_token }}">
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    ul { list-style-type: none; padding: 0; }
    li { padding: 10px 0; border-bottom: 1px solid #eee; }
    button { margin: 3px 2px; padding: 4px 8px; font-size: 12px; cursor: pointer; }
    .file-row { display: flex; align-items: center; gap: 8px; }
    .share-group { display: flex; flex-direction: column; gap: 4px; }
    .email-form { display: none; margin-top: 6px; font-size: 12px; }
    .email-form input,
    .email-form select { padding: 2px; font-size: 12px; }
    .link-input { display: none; margin-top: 6px; font-size: 11px; width: 220px; padding: 2px; }
    
    /* Tabs styling */
    .tabs { display: flex; gap: 10px; margin: 20px 0; }
    .tab { padding: 8px 16px; background: #f0f0f0; border: none; border-radius: 4px; cursor: pointer; }
    .tab.active { background: #007bff; color: white; }
    
    /* Trash specific styles */
    .trash-container { display: none; margin-top: 20px; }
    .file-item { padding: 12px; border: 1px solid #eee; border-radius: 4px; margin-bottom: 8px; }
    .file-info { margin-bottom: 8px; }
    .file-name { font-weight: bold; }
    .delete-info { color: #888; font-size: 0.9em; }
    .days-remaining { display: block; font-weight: bold; }
    .days-remaining.warning { color: #d32f2f; }
    .restore-btn { margin-top: 8px; }
    .no-files { color: #888; font-style: italic; padding: 20px; text-align: center; }
  </style>
</head>
<body>
<h1>Dashboard - {{ user.email }}</h1>

<!-- Upload Form -->
<form id="uploadForm" enctype="multipart/form-data">
  {% csrf_token %}
  <input type="file" name="file" required>
  <button type="submit">Upload File</button>
</form>

<!-- Tabs Navigation -->
<div class="tabs">
  <button id="files-tab" class="tab active">ğŸ“ Your Files</button>
  <button id="trash-tab" class="tab">ğŸ—‘ï¸ Trash</button>
</div>

<!-- Files Container -->
<div id="files-container">
  <h2>Your Files</h2>
  <ul id="fileList">
    <li>Loading files...</li>
  </ul>
  <button onclick="loadFiles()">Refresh Files</button>
</div>

<!-- Trash Container (initially hidden) -->
<div id="trash-container" class="trash-container">
  <h2>Trash</h2>
  <div id="trash-list">
    <p>Loading trash...</p>
  </div>
</div>

<!-- âœ… Shared by You -->
<div style="margin-top: 30px;">
  <h3>ğŸ”— Shared by You ({{ shared_links|length }})</h3>
  {% if shared_links %}
    <ul style="list-style-type: none; padding: 0;">
      {% for link in shared_links %}
        <li style="padding: 8px 0; border-bottom: 1px solid #eee; font-size: 14px;">
          ğŸ“„ <strong>{{ link.file.original_name }}</strong>
          {% if link.slug %}
            <br><small>ğŸ”— Public link: <code>/s/{{ link.slug }}/</code></small>
          {% else %}
            <br><small>ğŸ“§ Email link (token: {{ link.token|truncatechars:12 }})</small>
          {% endif %}
          <br><small>
            ğŸ‘ï¸ Views: {{ link.view_count }} |
            â¬‡ï¸ Downloads: {{ link.download_count }}/{{ link.max_downloads }} |
            {% if link.is_expired %}<span style="color:#d32f2f">âŒ Expired</span>
            {% else %}<span style="color:#2e7d32">âœ… Active</span>
            {% endif %}
          </small>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p style="color: #666;">ğŸ•— No shared links yet.</p>
  {% endif %}
</div>

<script>
const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

// Upload file
document.getElementById('uploadForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const formData = new FormData(e.target);
  try {
    const res = await fetch('/files/upload/', {
      method: 'POST',
      body: formData,
      headers: { 'X-CSRFToken': csrfToken }
    });
    const data = await res.json();
    if (res.ok) {
      alert('âœ… File uploaded successfully!');
      loadFiles();
      e.target.reset();
    } else {
      alert('âŒ Upload failed: ' + (data.error || 'Unknown error'));
    }
  } catch (err) {
    alert('âŒ Network error: ' + err.message);
  }
});

// Load files (AJAX)
async function loadFiles() {
  try {
    const res = await fetch('/api/list/', {
      headers: { 'X-CSRFToken': csrfToken }
    });

    if (!res.ok) {
      document.getElementById('fileList').innerHTML = '<li>âŒ Failed to load files</li>';
      return;
    }

    const files = await res.json();
    if (files.length === 0) {
      document.getElementById('fileList').innerHTML = '<li>ğŸ“ No files uploaded yet.</li>';
    } else {
      document.getElementById('fileList').innerHTML = files.map(f => 
          `<li>
            <div class="file-row">
              <strong>${f.original_name || f.filename}</strong> (${Math.round(f.size / 1024)} KB)
              <button onclick="deleteFile(${f.id})">ğŸ—‘ï¸ Delete</button>
              <div class="share-group">
                <button onclick="toggleEmailForm(${f.id})">ğŸ“§ Share</button>
                <form id="email-form-${f.id}" class="email-form" onsubmit="return submitEmailShare(${f.id}, event)">
                  <input type="email" name="email" placeholder="Email" required>
                  <select name="role">
                    <option value="viewer">View</option>
                    <option value="editor">Edit</option>
                  </select>
                  <button type="submit">Send</button>
                  <button type="button" onclick="toggleEmailForm(${f.id})">âœ•</button>
                </form>
                <button onclick="copyLink(${f.id})">ğŸ”— Copy Link</button>
                <input type="text" id="link-input-${f.id}" class="link-input" readonly>
              </div>
            </div>
          </li>`
      ).join('');
    }
  } catch (err) {
    document.getElementById('fileList').innerHTML = `<li>âŒ Error: ${err.message}</li>`;
  }
}

// Toggle email form
function toggleEmailForm(fileId) {
  const form = document.getElementById(`email-form-${fileId}`);
  form.style.display = form.style.display === 'none' ? 'block' : 'none';
}

// Submit email share
async function submitEmailShare(fileId, e) {
  e.preventDefault();
  const form = e.target;
  const email = form.email.value.trim();
  const role = form.role.value;

  try {
    const res = await fetch(`/files/share/${fileId}/email/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrfToken,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ email, role })
    });

    const data = await res.json();
    if (res.ok) {
      alert('âœ… Shared successfully!');
      toggleEmailForm(fileId);
      form.reset();
    } else {
      alert('âŒ Share failed: ' + (data.error || 'Unknown error'));
    }
  } catch (err) {
    console.error('Email share error:', err);
    alert('âŒ Share error: ' + err.message);
  }
  return false;
}

// Copy public link
async function copyLink(fileId) {
  const btn = event.target;
  btn.disabled = true;
  btn.textContent = 'â³';

  try {
    const res = await fetch(`/files/share/${fileId}/`, {
      method: 'POST',
      headers: { 'X-CSRFToken': csrfToken }
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const { link } = await res.json();

    const input = document.getElementById(`link-input-${fileId}`);
    input.value = link;
    input.style.display = 'block';
    input.select();
    await navigator.clipboard.writeText(link);
    btn.textContent = 'âœ…';
  } catch (e) {
    console.error('Copy link failed:', e);
    btn.textContent = 'âŒ';
    alert('âŒ Failed to generate link. Check network/console.');
  } finally {
    setTimeout(() => {
      btn.disabled = false;
      btn.textContent = 'ğŸ”— Copy Link';
    }, 1500);
  }
}

// Delete file
async function deleteFile(id) {
  if (!confirm('Delete this file?')) return;
  try {
    const res = await fetch(`/files/delete/${id}/`, {
      method: 'POST',
      headers: { 'X-CSRFToken': csrfToken }
    });
    if (res.ok) {
      alert('âœ… Deleted');
      loadFiles();
    } else {
      const data = await res.json();
      alert('âŒ Delete failed: ' + (data.error || 'Permission denied'));
    }
  } catch (err) {
    alert('âŒ Delete error: ' + err.message);
  }
}

// Add this function to load trash files
async function loadTrashFiles() {
    try {
        const response = await fetch('/files/trash/', {
            headers: { 'X-CSRFToken': csrfToken }
        });
        const data = await response.json();
        const trashList = document.getElementById('trash-list');
        
        if (!trashList) {
            console.error('Trash list element not found');
            return;
        }
        
        if (data.files && data.files.length > 0) {
            trashList.innerHTML = data.files.map(file => `
                <div class="file-item trash-item">
                    <div class="file-info">
                        <span class="file-name">${file.original_name}</span>
                        <span class="file-size">${formatFileSize(file.size)}</span>
                        <span class="delete-info">
                            Deleted: ${new Date(file.deleted_at).toLocaleDateString()}
                        </span>
                        <span class="days-remaining ${file.days_remaining < 7 ? 'warning' : ''}">
                            ${file.days_remaining} days until permanent deletion
                        </span>
                    </div>
                    <button class="btn restore-btn" onclick="restoreFile(${file.id})">
                        Restore
                    </button>
                </div>
            `).join('');
        } else {
            trashList.innerHTML = '<p class="no-files">Trash is empty</p>';
        }
    } catch (error) {
        console.error('Error loading trash:', error);
        document.getElementById('trash-list').innerHTML = '<p class="no-files">Error loading trash</p>';
    }
}

// Add restore function
async function restoreFile(fileId) {
    if (!confirm('Restore this file?')) return;
    
    try {
        const response = await fetch(`/files/restore/${fileId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            }
        });
        
        const data = await response.json();
        if (data.success) {
            alert('File restored successfully!');
            loadTrashFiles();  // Reload trash
            loadFiles();       // Reload main files
        } else {
            alert(data.error || 'Failed to restore file');
        }
    } catch (error) {
        console.error('Error restoring file:', error);
        alert('Failed to restore file');
    }
}

// Helper function for file size formatting
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Tab switching functionality
document.getElementById('files-tab').addEventListener('click', () => {
    document.getElementById('files-container').style.display = 'block';
    document.getElementById('trash-container').style.display = 'none';
    document.getElementById('files-tab').classList.add('active');
    document.getElementById('trash-tab').classList.remove('active');
    loadFiles();
});

document.getElementById('trash-tab').addEventListener('click', () => {
    document.getElementById('files-container').style.display = 'none';
    document.getElementById('trash-container').style.display = 'block';
    document.getElementById('files-tab').classList.remove('active');
    document.getElementById('trash-tab').classList.add('active');
    loadTrashFiles();
});

// Initial load
document.addEventListener('DOMContentLoaded', function() {
    loadFiles();
});
</script>
</body>
</html>